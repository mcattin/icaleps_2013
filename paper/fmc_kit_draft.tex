\documentclass{JAC2003}

%%
%%  This file was updated in April 2009 by J. Poole to be in line with Word templates
%%
%%  Use \documentclass[boxit]{JAC2003}
%%  to draw a frame with the correct margins on the output.
%%
%%  Use \documentclass[acus]{JAC2003}
%%  for US letter paper layout
%%

\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{color}
\usepackage{comment}

%%
%%   VARIABLE HEIGHT FOR THE TITLE BOX (default 35mm)
%%

\setlength{\titleblockheight}{27mm}

\begin{document}
\title{CERN's FMC KIT}

\author{Matthieu Cattin\thanks{matthieu.cattin@cern.ch}, Evangelia Gousiou, Javier Serrano, Erik van der Bij, Tomasz W\l{}ostowski,\\
CERN, Geneva, Switzerland}

\maketitle

\begin{abstract}
  In the context of the renovation of controls and data acquisition electronics for accelerators the BE-CO-HT section at CERN has designed a kit based on carriers and mezzanines following the VITA FPGA Mezzanine Card (FMC) standard. Carriers exist in VME64x and PCIe form factors, with a PXIe carrier underway. Mezzanines include an Analog to Digital Converter, a Time to Digital Converter, a fine delay generator and a Digital Input/Output. All of the designs are licensed under the CERN Open Hardware Licence (OHL) and commercialised by companies.

This paper discusses the benefits of this carrier-mezzanine strategy and of the Open Hardware (OH) based commercial paradigm.
It also explains the design of each layer of the FMC kit, from the hardware to the gateware and the Linux device driver.
In addition, several tools to help designers developing gateware for mezzanines and new concepts such as the Self-Describing Bus (SDB) and the fmc-bus are presented.
Lastly, some of the plans for the future of the FMC kit and Open Hardware Repository (OHWR) are brought up.
\end{abstract}

\section{INTRODUCTION}
%* Use abstract or conclusions of Erik's article.
%* Standards used
%* Example carrier
%* Example mezzanine
%* Motivations to design new kit
%   -> obsolete hw
%   -> hard to maintain, debug (closed source, no source)
%   -> no common design base (poor/no re-use)
%   -> discontinued commercial products
One of the missions of the BE-CO-HT section is to specify, design and provide electronic modules for the control systems of all accelerators at CERN.
The section has to support a large variety of hardware among which digital and analogue I/O, level converters, serial links and timing boards.
Replacing obsolete modules and upgrading the control systems to new technologies requires a continuous flow of design work.
The coming chapters describe the direction taken by the section to fulfill this mandate.

\subsection{Motivations}
Many of the electronic modules used in the control systems, COTS (Commercial Of The Shelf) or specifically designed at CERN had become impossible to maintain for several reasons.
In particular, most of those modules contain obsolete components or are discontinued products.
Some of the modules are twenty years old and often the documentation and the knowledge is scarce or lost, making the debugging or repair very hard and time-consuming.
Also a very limited team has to maintain a large variety of modules.
Finally some modules are maintained in operation with limited stock and cannot be used in new installations.
% => almost no re-use, no design strategies to help re-use, only some copy/paste here and there, one engineer per board (no much collaboration)
%=>  buggy black boxes!

\subsection{New Approach}
In charge of this renovation, the BE-CO-HT section at CERN decided to develop new hardware modules based on the following principles:
\begin{Itemize}
\item Openness of designs.
\item Modularity and re-usability.
\item Compliance with existing standards.
\end{Itemize}

The carrier-mezzanine concept was chosen to reduce the number of different modules and increase the modularity.
The carrier boards are platform-dependent and meant to be as generic as possible, while the mezzanines are platform-independent and specific to a particular task.
The carriers are built around a central FPGA (Field Programmable Gate Array) and includes an interface to the host bus, some data storage memory, a clock distribution and PLLs compatible with White Rabbit (WR)~\cite{wr} requirements, a few Gigabit links to communicate between carriers and finally one or more FMC slots.
The mezzanine is interfacing with the external world and mostly contains analogue and signal conditioning electronics.
%\textcolor{red}{
%The PCB (Printed Circuit Board) design of a carrier is likely to be more complex than the one of a mezzanine.
%Therefore, only one carrier per platform type has been designed.
%Then for each different functionalities, mezzanines with simpler PCB, have been developed.
%}

The standard that best fits our requirements in terms of carrier-mezzanine approach is the ANSI/VITA FMC standard~\cite{fmc}.
For instance, the FMC standard is very flexible as the connections between carrier and mezzanine are mostly agnostic with regard to the signal direction, electrical level and protocol.

In order to improve the modularity and re-usability of the HDL (Hardware Description Language) designs, the Wishbone~\cite{wishbone} bus was chosen as the standard to interconnect the diverse logic blocks inside the carrier's FPGA.
To enhance the HDL code re-use, generic Wishbone cores and other utility cores were created and gathered in libraries.
Moreover, to help automate the design flow (dependencies solving, synthesis, simulation, place \& route), tools and scripts were developed.

The same modularity concept applies to the Linux device driver layer as well.
In the frame of the driver development for the FMC kit, new concepts like the software fmc-bus~\cite{fmc-bus} and the ZIO framework~\cite{zio} have emerged and are making their way to the official Linux kernel.
% -> Need David's help to clarify a bit!!

To allow sharing of design information the OHWR was created~\cite{icalepcs}.
It is a collaborative web-based platform that hosts the boards, the HDL and the software development of OH projects.
%An OHWR project consists, among other things, of a wiki space, a repository, a mailing list, an issue tracking system and a file storage area.
All the boards of the FMC kit are developed under OHWR and the hardware designs are licensed under the CERN OHL (Open Hardware Licence).
% -> FMC kit uses OHWR
% -> other groups and companies develop proj on OHWR
% -> OHL
% -> examples ?

\section{DESIGN}
%* Infrastructure created (Ecosystem)
%    - Hardware blocks (WR, memory, clock circuits, mechanics FMC front-panel)
%    - Wishbone -> 	IP modules, very easy porting PCIe to VME64x
%    - SDB filesystem
%    - Drivers (FMC bus)
%    - PTS (Thedi fast)
%* Example of an ADC structure
%* Helper tools/scripts (hdlmake, wbgen, ucfgen, ...)
%* Release procedure (freeze all layers)
%* More details on cern mezzanines and carriers ??
%    - white rabbit capability of carriers
%* PTS: bar-code, logfiles

The FMC kit is designed based on well-established standards and in a modular way.
This flexible approach is applied on every layer, from the hardware with the schematics and layout to the software with the driver, including the gateware and the test environment.
The idea is to have a wide and solid base of building blocks that can be re-used in many different designs.
As those modules are meant to be used by many people, also outside of CERN, the code and the documentation should be of good quality.
Over time, we hope that feedback from users will help to improve shared modules.
Finally, new developments will be speeded up as most of the required blocks are already available, documented and tested.

%\textcolor{red}{
%On the hardware side, the SFP interface and the clocking part is re-used between WR-enabled carrier designs.
%Also, all the mezzanine designs share a common part; an eeprom to store IPMI informations.
%In addition, a 1-wire thermometer containing a 64-bit unique ID is placed on all CERN designs.
%}
\subsection{Modularity: the Wishbone Case}
The most explicit example of modularity and block re-use is probably the gateware design.
The gateware is the HDL code used to generate the bitstream that configures the carrier's FPGA.
The gateware design is articulated around one or several Wishbone buses.
The Wishbone standard is well adapted to inter-block communication because it is simple and easy to implement and versatile.
In order to fulfill the high throughput high latency of certain designs, a new pipelined mode was proposed to the Wishbone standard maintainers. The new mode was accepted and is now part of the latest revision of the standard.

Several bus master modules from OpenCores~\cite{opencores} are used to communicate with components outside the FPGA that have standard serial interfaces (SPI, I2C or 1-wire).
Thanks to their Wishbone interface, those modules can be integrated to the design without any modification.

For other bus interfaces like VME64x~\cite{vme} and PCIe, where no OpenCores modules were available, new HDL components were created.

For designing specific registers that have to be interfaced to the Wishbone bus, a small helper tool was developed.
This tool called wbgen2~\cite{wbgen2} generates HDL (VHDL, Verilog), C headers and documentation (html, tex, texinfo) from a single description file.
The generated module can be directly connected to a Wishbone bus, while the other side is connected to the application.
%Extra synchronisation to a clock different from the Wishbone clock is also available.

Another very important component in the Wishbone topology is the crossbar switch.
It allows to connect and arbitrate several masters and several slaves.
The development of this essential component was carried out in GSI (Helmholtzzentrum f\"ur Schwerionenforschung GmbH).

\begin{figure}[htb]
   \centering
   \includegraphics*[width=82mm]{figures/spec-fmc-adc_arch.eps}
   \caption{FMC-ADC gateware architecture.}
   \label{spec-fmc-adc_arch}
\end{figure}

A good example of the flexibility offered by the Wishbone bus interconnect is illustrated in Fig.~\ref{spec-fmc-adc_arch}.
It represents the FMC-ADC~\cite{fmc-adc} HDL architecture.
The wishbone bus A is mapped in the PCI BAR0 address space.
It allows access to the configuration and control peripherals.
The B and C buses are separate from the other bus and used only to transfer data to/from the DDR memory.
Due to its size, the DDR memory is not directly mapped in the PCI address space.
The only way to access it is through DMA using the controller in the PCIe interface module.

\subsection{New Tools and Concepts}
% -> Add a small intro sentence here

%While for the board development the re-use is mainly done via schematics and layout copy/paste, on the HDL side it is handled with proper dependencies resolution.
To make the reuse of the blocks easier, the helper tool hdlmake~\cite{hdlmake} was developed and is available on the OHWR.
The designer has to write \textit{Manifest} files describing the project structure and dependencies.
Then hdlmake automatically fetches the required libraries from different locations (remote repositories, local folders) and generate Makefiles for synthesis and simulation.
This tool helps to increase the productivity by making the HDL design flow more automated.

In order for the driver to automatically discover the gateware architecture and load the corresponding modules, the SDB (Self Describing Bus) concept~\cite{sdb} was developed.
It consists of a series of structures that describes the Wishbone blocks and their mapping in the address space.
Additionally, SDB meta-information records allows to uniquely identify the gateware.
Those meta-information records contain for example the synthesis date, repository URL, commit ID, etc...
%=> integration of sdb meta-info into build process (avoid manual editing)

Prior to loading the final bitstream to a carrier's FPGA, the driver has to make sure the expected mezzanine is plugged in the FMC slot.
This is to avoid any hardware damage that could occur if an incompatible bitstream is loaded.
Therefore, when a carrier starts up, it loads the FPGA with a \textit{golden} bitstream that only allows access to the carrier peripherals and to the mezzanine standard EEPROM.
By reading the IPMI information of the mezzanine EEPROM, the driver can verify that the correct mezzanine is attached.

The mezzanine EEPROM does not only contain the IPMI part defined in the ANSI-VITA 57.1 standard, but also other mezzanine specific data such as calibration values.
To elegantly handle the different data in the eeprom, a simple file system was created.
This file system is called SDBFS~\cite{sdbfs} as it is based on SDB data structures.

%\textcolor{red}{
%On the software side, the modularity is also present.
%The Linux device driver for a given carrier + mezzanine(s) assembly is in fact made of several kernel objects.
%The SDB and fmc-bus features will be integrated in the official Linux kernel.
%}


%\textcolor{red}{
A test environment was developed in Python and interfaced with the hardware via a simple I/O driver and a library to verify the boards after manufacturing.
Such an environment allows to significantly reduce the testing time and the risk of mistakes by automating most of the process.
The same environment is also used to test the gateware.
%}
%=> human mistake reduction in test
%=> automation -> control external instruments, design switch box, ...
% -> also gateware test

\subsection{Porting Made Easy}
With such a modular HDL architecture, porting a design from one carrier to another is straightforward.
For example, porting the FMC-ADC HDL from the SPEC (PCIe carrier with one FMC slot) to the SVEC (VME64x carrier with two FMC slots) took about one week of work.
This only involved changing the bus interface to the host from PCIe to VME64x and duplicating the FMC-ADC block.
Note that designing a VME64x ADC board from scratch would have taken several months.

The same applied to the Python testing environment.
Most of the code written to test the FMC-ADC on the SPEC carrier was re-used to test two FMC-ADC on a SVEC carrier.
Again, only the bus interface layer had to be changed from PCIe to VME.
%=> Example of Conv-ttl-blo PTS from SVEC PTS

\begin{comment}
\subsection{Release Concept REMOVE TO ADD PICTURE}
Usually, a single product involves several different OHWR projects.
By product, we mean a functional set of carrier and mezzanine boards along with gateware and software (e.g FMC-ADC + SPEC).
For a user to be able to use a product, at least three projects are needed; the carrier project for the golden bitstream, the mezzanine project for the application bitstream and the mezzanine software support project for the Linux device driver and test program.
To have better traceability, a release procedure was put in place.
For each component (gateware or software), the development is frozen into a \textit{release}.
In addition, compatible releases of the gateware and software are bundled together in an archive.
\end{comment}



\section{OPEN HARDWARE}
%* OH: Some examples of bugs found by external people (would not have received if not open)
%    - SFP mechanics (user)
%    - regulator voltage (INCAA)
%    - (check Issues for HW)
%* OH: Examples of HDL/software pbl found by others
%    - (check mailing lists)
%    - gnum core patch (from Andrey Abramov)
%* Other:
%    - OH forces to have better quality documentation
%* Re-use of design, examples:
%    - SPEC -> SPEXI, etc...
%* Re-use of final product, examples:
%    - TE/EPC (SVEC)
%    - External users (Commercial availability)
%* Worries:
%    - See article TWEPP: http://iopscience.iop.org/1748-0221/7/01/C01032/
%       -> technologie transfer (cern mission)
%    - Startup of production takes time
%
%- test + warranty by companies
%- open != free -> we pay for support
%- FMC front panel small dimensions
%- Talk about other CERN section developing FMC and carrier?

For the last three years CERN's controls group designed all its new projects in a fully open fashion using the OHWR platform to improve collaboration and sharing.
In this section, the advantages and drawbacks of open hardware designs will be discussed.
This is based on our experience of collaboration with other groups at CERN, external partners and companies.

\subsection{Towards Better Designs}
Some of the main advantages of an open hardware design are the peer review and user feedback.
Publishing the design, even during the development phase, allows for peer review and detection of early bugs or misdesign problems.
Giving the production task to companies that design their own products (as opposed to production companies) is also an important point of the whole process.
As they will not only spot manufacturing issues, but also design problems.
This is another important stage of checking that avoids producing faulty prototypes or series.
%=> SVEC regulator voltage example

The feedback from users is also very valuable.
Having access to the source helps users to better understand the design and give useful comments or propose improvements.
Moreover, some users are using our designs in different, sometimes unexpected, conditions.
%=> SPEC in other computer (SFP mechanical problem)
%=> SPEC in extreme temperature
In closed designs, users can only report bugs.
They are not able to look themselves into the schematics or HDL to find out what is going wrong.
Profiting from users' knowledge to improve the design is another advantage of openness.
%=> time spend in doc is counterbalanced by users feedback

All those additional steps, even if they extend the development phase, are crucial to find issues before a module is deployed in the CERN installations.
In the end, the time spent in design will be counterbalanced by a lower down-time of the accelerators.

% -> takes time but:

%\subsection{Knowledge Transfer}
%=> something more on KT instead of the Re-use section???

\subsection{More collaborations}
% Offload cern:
%  - production, test
%  - waranty, repair
%  - hw design
%  - sw dev
The BE-CO-HT section collaborated with other groups at CERN as well as with external associates and companies to develop the FMC kit.
For example, boards like the PCIe, the VME64x and the PXIe carriers were specified by CERN and the schematics and layout sub-contracted to companies.
%\textcolor{red}{Several iterations of design review were necessary before producing the first prototypes.}
An important part of the software framework was also developed by a company outside CERN.

As the boards are produced and tested by companies, it offloads the team at CERN and allows to concentrate on other tasks like development and integration of the new modules to the existing control systems.
In addition, the boards come with warranty that includes the repair of faulty devices.
Like the hardware, the HDL core libraries are developed in collaboration with other institutes.

Open hardware considerably facilitate collaborations and design re-use.
The OHWR already counts several example of boards that were used as a basis to design new ones.
For example, the PCIe FMC carrier (SPEC) has already served as a starting-point to develop two other boards, a PXIe FMC carrier and a PowerPC FMC carrier.
Besides, other groups at CERN or outside are integrating boards from the kit, mainly FMC carriers, in their own projects.
These external partners also contribute to the OWHR with new hardware or HDL designs.

%\textcolor{red}{
%Another great advantage of open designs is the re-usability.
%Not only at the schematics, HDL or software levels, but also at the board level.
%}
% -> spin-off boards designed by companies

% >> to conclusion ?
%\textcolor{red}{
%The controls group at CERN is mostly a service provider for other groups.
%One of the services is to provide standard front-end platforms and general purpose modules.
%With the FMC carrier/mezzanine model, the controls group now provides all the required infrastructure for hardware (FMC carriers), gateware (HDL core collection) and software (modular driver design). With this framework, other groups can develop their specific application for each layer.
%}
% >> to conclusion ?


\subsection{A Few Drawbacks}
Even though the open hardware model perfectly fits our needs, we can still list a few disadvantages.
Among which the additional effort to give support to collaborators and users.
This consists mainly in replying to questions, and sometimes in helping setting up a system.
But we believe that this extra workload can be mitigated with additional quality in the project, essentially a good and up-to-date documentation.
Furthermore, we expect support to partly shift towards companies selling OH designs as their own products.

Finally, we can mention the fact that the first collaboration with a company to produce an OH board took more time than through the conventional work-flow.
In general, it takes about one year between the order and the series delivery.
It includes a pre-series of a limited number of boards to validate the production process.
But this additional time can be explained by the design iterations following the feedback from the company producing a board.
%\textcolor{red}{And by PCB quality issues in pre-series.}
% -> explain why it takes more time?
%      - quality standards not met in pre-series
%      - feedback on manufacturability/design


\section{PERSPECTIVES}
%* KiCAD
%* Icarus?
%* Push more support to companies
%* support users and improve doc on OH, FAQ, better structure (projects, documentation, repositories)
%* Future platform (PXIe, etc... ??)
%   -> limitations of current platforms (PCIe, VME)
This chapter discusses the future improvements to the FMC kit and the OHWR projects.

\subsection{Universal PCB Design Tool}
Different institutes, laboratories or companies might use various PCB design tools.
Nowadays there is no common file format to transfer projects between those EDA tools.
This is a serious limitation to re-usability.
Unfortunately open source alternatives are not adequate to be used in complex, multi-layer PCB design projects.
For those reasons the controls group at CERN decided to encourage the improvement of KiCad, one of the open source EDA software.
The objective is to help enhance KiCad in such a way that it becomes an efficient tool for PCB design that people can use to share their design information without compromising productivity.

\subsection{Improving Quality}
The last few years were dedicated to the development of boards and the production of the first series in collaboration with industry.
Now that the basic building blocks of the kit are released or will soon be, an effort will be made on the project's quality.
In order to facilitate users and new developers to start with OHWR projects, the documentation should be completed and the projects and repositories structure should be cleaned and unified.

In the meantime, FAQ pages were created to centralise the questions received and answered by e-mail.
Moreover we expect the companies selling OH products to be able to give support to the users.

\subsection{Next Front-end Computer Platform}
Another concern is the choice of the future platform for the front-end computers at CERN.
Currently, the two platforms supported by the BE-CO group are VME64x and PICMG 1.3 (industrial PC with PCI and PCIe slots).
So far, FMC carriers were developed for VME64x, PCIe and PXIe.
The latter is supported by the EN-ICE group at CERN.

The two supported platforms have their limitations.
For example, the PC form-factor is not well suited regarding on-site board replacement.
A VME64x board on the other hand can easily be replaced.
But here the concern is more on the backplane bus throughput.
In addition, both standards are missing clock and trigger distribution lines in the backplane, which is a very important feature in a distributed control systems.
Therefore the CERN's controls group is looking for a new standard for its front-end computer.


\section{CONCLUSIONS}
%* standards -> good choice (why?)
%* modularity -> fast dev, port to new platform
%* fmc proj, hdl lib, driver slowly getting mature -> still need better struct and organisation
% * tools (hdlmake, etc...)
% * better design when open, forces to have good doc
% * 

As a service provider, the BE-CO-HT section at CERN has to support a large variety of electronic modules and continuously design new boards to replace the obsolete ones.
In order to fulfill this mission with limited human resources, the next generation of control boards have been developed in an OH way, sometimes in collaboration with external partners.
The new kit was designed to be modular and based on standards such as FMC and Wishbone in order to promote re-usability and sharing.

The controls group now provides carriers for the PCIe and VME64x platforms and a set of mezzanines.
With the FMC kit also comes all the required infrastructure to design hardware, gateware and software .
In addition, several tools like hdlmake and wbgen2 were developed in order to facilitate the HDL design process.
With this framework, the development of new project and the porting of existing mezzanine is made easier and faster.

By opening the designs and allowing for feedback and suggestion from the users, the quality of the designs is improved.
For example a good documentation avoids spending to much time supporting users.
% ~
The production, testing and support tasks were handed over to companies which are now selling OH boards as their own product.
This new model allowed to unload the section from boring tasks.
% ~

The FMC ecosystem developed by the BE-CO-HT section and its collaborators over the last few years is now getting mature.
All the basic pieces like carriers, mezzanines, HDL libraries and Linux device drivers are available on the OHWR.
Although, most of the OHWR project are still in development mode and will require a consolidation effort in the coming years.

We can see that the strategy chosen by the section is already paying off.
For example
\textcolor{red}{because...}
Whatever the next front-end platform will be, it is just a matter of designing a new carrier. All the mezzanine kit and development framework is already there.



%\begin{thebibliography}{9}   % Use for  1-9  references
\begin{thebibliography}{99} % Use for 10-99 references

\bibitem{wr}
J. Serrano \textit{et al.}, ``The White Rabbit Project'', ICALEPCS 2009

\bibitem{fmc}
``FPGA Mezzanine Card (FMC) Standard'', ANSI/VITA 57.1-2008 (R2010), ISBN 1-885731-49-3

\bibitem{wishbone}
``WISHBONE Revision B.4 Specification'', OpenCores Organization, 2010

\bibitem{opencores}
OpenCores, \texttt{opencores.org}

\bibitem{wbgen2}
wbgen2, \texttt{www.ohwr.org/projects/wishbone-gen}

\bibitem{vme}
``VME64x Extensions'', ANSI/VITA 1.1-1997, ISBN 1-885731-12-4

\bibitem{sdb}
A. Rubini, W. Terpstra, M. Vanga, ``Self-Describing Bus (SDB), Version 1.1'', OHWR, 2013, \texttt{www.ohwr.org/projects/fpga-config-space}

\bibitem{sdbfs}
A. Rubini, ``SDBFS, A Flash File-system based on SDB data structures'', OHWR, 2012, \texttt{www.ohwr.org/projects/fpga-config-space}

\bibitem{hdlmake}
hdlmake, \texttt{www.ohwr.org/projects/hdl-make}

\bibitem{fmc-adc}
FMC-ADC, \texttt{www.ohwr.org/projects/fmc-adc-100m14b4cha}

\bibitem{fmc-bus}
A. Rubini, ``FMC Bus Abstraction for Linux, A kernel bus to support FMC mezzanines and carriers'', OHWR, 2013 , \texttt{www.ohwr.org/projects/fmc-bus}

\bibitem{zio}
ZIO, \texttt{www.ohwr.org/projects/zio}

\bibitem{icalepcs}
E. van der Bij \textit{et al.}, ``Open hardware for CERN's accelerator control systems'', ICALEPCS 2011

\end{thebibliography}

\end{document}
